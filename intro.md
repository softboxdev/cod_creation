
### Введение

Архитектура сети — это высокоуровневый план, который объединяет все перечисленные вами компоненты. Это не просто схема соединения кабелей, а целостная стратегия, определяющая как данные будут перемещаться, управляться и защищаться в пределах организации. Представьте, что это проект здания: топология — это его каркас и планировка комнат, проектирование — это процесс создания этого проекта с учетом всех требований, а фабрика — это современная, умная и автоматизированная инфраструктура, которая заменяет старые, громоздкие способы строительства.

---

## 1. Топологии сети

**Топология сети** — это физическое или логическое расположение устройств и связей между ними в сети. Это "карта" сети.

### Физическая топология (Как проложены кабели?)
Описывает реальное физическое расположение устройств и сред передачи данных.

1.  **Шинная (Bus):**
    *   **Как работает:** Все устройства подключены к одному общему кабелю (магистрали). Данные, отправленные одним устройством, передаются по всей магистрали и могут быть приняты всеми остальными.
    *   **Плюсы:** Простота и низкая стоимость построения.
    *   **Минусы:** Низкая надежность — обрыв кабеля нарушает работу всей сети. Низкая производительность — коллизии (конфликты данных) при одновременной передаче, проблемы с безопасностью.
    *   **Применение:** Исторически в Ethernet сетях 10Base2/10Base5, сейчас практически не используется.

2.  **Звезда (Star):**
    *   **Как работает:** Все устройства подключены к центральному коммутатору (Switch) или концентратору (Hub). Это самая распространенная топология в локальных сетях (LAN).
    *   **Плюсы:** Высокая надежность — выход из строя одного кабеля или устройства не влияет на остальную сеть. Легко добавлять новые устройства и диагностировать проблемы.
    *   **Минусы:** Выход из строя центрального коммутатора парализует всю сеть.
    *   **Применение:** Практически все современные офисные и домашние сети.

3.  **Кольцевая (Ring):**
    *   **Как работает:** Устройства соединены в замкнутое кольцо, и данные передаются последовательно от одного устройства к следующему, всегда в одном направлении.
    *   **Плюсы:** Упорядоченный доступ к среде, отсутствие коллизий.
    *   **Минусы:** Низкая надежность — выход из строя одного устройства или кабеля разрывает кольцо и останавливает всю сеть (решается за счет двойного кольца, как в FDDI).
    *   **Применение:** Token Ring, FDDI, некоторые сети операторов связи.

4.  **Полносвязная (Mesh):**
    *   **Как работает:** Каждое устройство имеет прямое соединение с каждым другим устройством.
    *   **Полная полносвязность:** Максимальная отказоустойчивость и производительность.
    *   **Частичная полносвязность:** Соединения есть только между наиболее критичными устройствами.
    *   **Плюсы:** Высокая надежность и избыточность путей для данных.
    *   **Минусы:** Чрезвычайно высокая стоимость и сложность управления (количество соединений растет по формуле `n*(n-1)/2`).
    *   **Применение:** Магистральные сети интернет-провайдеров, критически важные центры обработки данных.

5.  **Ячеистая (Mesh для беспроводных сетей):**
    *   **Как работает:** Каждое беспроводное устройство (узел) соединяется с множеством других узлов, создавая динамическую, самоорганизующуюся и самовосстанавливающуюся сеть.
    *   **Применение:** Умные дома (Zigbee, Z-Wave), городские Wi-Fi сети, военные и спасательные системы.

### Логическая топология (Как данные видят сеть?)
Описывает то, как данные фактически передаются по сети, независимо от ее физической компоновки.

*   **Пример:** Физическая топология "Звезда" может иметь логическую топологию "Шина", если в центре сети используется концентратор (Hub), который просто повторяет трафик на все порты. И наоборот, при использовании коммутатора (Switch) логическая топология становится более "прямой" (point-to-point), так как коммутатор intelligently направляет трафик только целевому устройству.

---

## 2. Основы проектирования сети

Проектирование сети — это итеративный процесс, который превращает бизнес-требования в техническую спецификацию. Он следует принципам иерархической модели, чаще всего — **трехуровневой (Cisco Hierarchical Model)**.

### Трехуровневая модель проектирования

1.  **Ядро (Core Layer):**
    *   **Задача:** Скорость и надежность. Быстрая пересылка трафика между географически распределенными сегментами сети.
    *   **Принципы:** Не производит фильтрацию трафика, не применяет политики. Основные характеристики — высокая пропускная способность, избыточность (резервные ссылки и оборудование), отказоустойчивость и низкая задержка.
    *   **Оборудование:** Высокопроизводительные маршрутизаторы и коммутаторы.

2.  **Распределительный уровень (Distribution / Aggregation Layer):**
    *   **Задача:** Агрегация трафика от уровня доступа, определение границ широковещательных доменов, реализация сетевых политик.
    *   **Принципы:** Здесь работают:
        *   **Маршрутизация:** Определение путей между VLAN.
        *   **Безопасность:** ACL (Access Control Lists), фильтрация трафика.
        *   **Агрегация каналов:** Объединение нескольких физических линий в одну логическую (EtherChannel).
        *   **Контроль качества обслуживания (QoS):** Приоритизация трафика (например, голосовой трафик VoIP важнее веб-серфинга).
    *   **Оборудование:** Коммутаторы уровня 3 (L3 Switches).

3.  **Уровень доступа (Access Layer):**
    *   **Задача:** Предоставление конечным пользователям и устройствам доступа в сеть.
    *   **Принципы:**
        *   Подключение компьютеров, IP-телефонов, принтеров, камер.
        *   Создание границ коллизионных доменов (с помощью коммутаторов).
        *   Сегментация сети на VLAN (Virtual LAN) — логическое разделение пользователей по отделам или функциям.
        *   Port Security, аутентификация пользователей (например, 802.1X).
    *   **Оборудование:** Коммутаторы уровня 2 (L2 Switches), точки доступа Wi-Fi.

### Ключевые принципы проектирования

*   **Масштабируемость:** Сеть должна легко расти вместе с бизнесом.
*   **Отказоустойчивость:** Отсутствие единой точки отказа. Достигается за счет избыточности оборудования и каналов связи.
*   **Безопасность:** "Security by Design" — безопасность закладывается на этапе проектирования, а не добавляется потом. Сегментация (VLAN, Zoning), контроль доступа, шифрование.
*   **Управляемость:** Сеть должна быть легко мониторимой и управляемой (использование SNMP, NetFlow, систем управления).
*   **Производительность:** Удовлетворение требований к пропускной способности и задержкам для критичных приложений.

---

## 3. Технологии построения фабрик (Network Fabric)

**Сетевая фабрика (Fabric)** — это эволюция классических сетей. Если традиционная сеть — это набор "умных" устройств (коммутаторов и маршрутизаторов), которые независимо друг от друга принимают решения о маршрутизации, то фабрика — это единая, виртуализированная, интеллектуальная и программно-определяемая система.

### Проблемы традиционных сетей, которые решает фабрика:

1.  **Сложность управления:** Настройка каждого устройства вручную (CLI).
2.  **Медленная адаптация:** Трудно и долго подстраиваться под изменения (добавление сервера, переезд пользователя).
3.  **Вертикальная масштабируемость:** Чтобы увеличить мощность, нужно заменять оборудование на более мощное.
4.  **Жесткая связность:** Логика сети (IP-адреса, VLAN) жестко привязана к физической инфраструктуре.

### Как работает сетевая фабрика?

Фабрика абстрагирует физическую сеть и создает единое логическое устройство, которым можно управлять централизованно.

**Ключевые компоненты и концепции:**

1.  **Control Plane / Data Plane Separation:**
    *   **Data Plane (Плоскость данных):** Пересылка пакетов "в железе" (ASIC коммутаторов). Остается распределенной на устройствах для скорости.
    *   **Control Plane (Плоскость управления):** Логика принятия решений (какие маршруты использовать, какие политики применять). **Выносится в центральный контроллер.**

2.  **Централизованный Контроллер:** "Мозг" фабрики. Он имеет глобальное представление обо всей сети. Администратор задает политики на контроллере ("пользователь из VLAN 10 может общаться с сервером в VLAN 20"), а контроллер транслирует эти политики на все физические коммутаторы.

3.  **Overlay / Underlay Модель:**
    *   **Underlay (Фундаментальная сеть):** Физическая инфраструктура (коммутаторы, кабели, порты). Ее задача — обеспечить максимально простую и надежную IP-связность между всеми узлами фабрики. Используются простые и быстрые протоколы (часто BGP или OSPF).
    *   **Overlay (Накладываемая сеть):** Виртуальная сеть, которая создается поверх Underlay. Она переносит трафик конечных устройств (серверов, пользователей). Overlay "инкапсулирует" оригинальные пакеты в новые, которые передаются через Underlay. Это позволяет создавать логические сети, независимые от физической топологии.

4.  **Технологии инкапсуляции (для Overlay):**
    *   **VXLAN (Virtual Extensible LAN):** Наиболее популярная технология. Инкапсулирует кадр Ethernet в пакет UDP. Позволяет создавать до 16 миллионов логических сегментов (против 4094 в традиционных VLAN).
    *   **NVGRE, GENEVE** — другие варианты.

### Основные технологии/архитектуры фабрик:

1.  **Cisco ACI (Application Centric Infrastructure):**
    *   **Философия:** Управление на уровне приложений. Администратор описывает, какие компоненты приложения (веб-сервер, сервер приложений, БД) как должны общаться.
    *   **Контроллер:** APIC (Application Policy Infrastructure Controller).
    *   **Underlay протокол:** IS-IS.
    *   **Overlay протокол:** VXLAN.

2.  **VMware NSX:**
    *   **Философия:** Программное решение, которое работает поверх *любого* стандартного сетевого оборудования. Создает "программно-определяемый дата-центр".
    *   **Контроллер:** NSX Manager.
    *   **Overlay протокол:** VXLAN (GENEVE в новых версиях).
    *   **Особенность:** Очень тесно интегрируется с виртуальными машинами и гипервизорами vSphere.

3.  **Juniper Apstra:**
    *   **Философия:** Intent-Based Networking (Сеть на основе намерений). Вы говорите системе *ЧТО* вы хотите (намерение), а система сама вычисляет *КАК* это реализовать и постоянно проверяет соответствие сети вашему намерению.
    *   **Особенность:** Мультивендорность — может управлять оборудованием разных производителей.

### Преимущества сетевых фабрик:

*   **Автоматизация:** Снижение количества ручных операций и человеческих ошибок.
*   **Аgility:** Быстрое развертывание сервисов и адаптация к изменениям.
*   **Единая политика безопасности:** Политики следуют за workload (виртуальной машиной, контейнером), где бы он ни находился.
*   **Упрощение операций:** Единая точка управления для всей сети.
*   **Горизонтальная масштабируемость:** Легко добавлять новые узлы в фабрику.

---



Эволюция выглядит так:

**Топологии** -> **Иерархическое проектирование** -> **Сетевая фабрика**

Сначала мы научились правильно "расставлять мебель" в сети (топологии), затем создали для нее эффективную и отказоустойчивую "архитектуру здания" (проектирование), и, наконец, перешли к созданию "умного, самонастраивающегося здания", где все системы интегрированы и управляются из единого центра (фабрика). Понимание всех трех компонентов необходимо для проектирования современных, надежных и гибких сетей.

Давайте подробно разберем, как работает построение **Underlay-сети** с использованием различных протоколов. Это фундаментальная тема для современных сетей, особенно для Fabric-архитектур (Cisco ACI, VXLAN EVPN и др.).

## Что такое Underlay-сеть и зачем она нужна?

**Underlay (Фундаментальная сетя)** — это базовая транспортная сеть, которая обеспечивает **IP-связность между всеми узлами** будущей overlay-сети (например, между VTEP - VXLAN Tunnel End Points).

**Аналогия:** Представьте, что Underlay — это система автомобильных дорог и развязок, а Overlay — это маршруты конкретных автобусов (VXLAN туннелей), которые ездят по этим дорогам.

**Основные требования к Underlay:**
- **Простота:** Минимум конфигурации
- **Масштабируемость:** Поддержка большого количества узлов
- **Скорость сходимости:** Быстрое восстановление при сбоях
- **Предсказуемость:** Детерминированная маршрутизация

---

## 1. Построение Underlay сети с OSPF

**OSPF (Open Shortest Path First)** — протокол состояния каналов (Link-State), самый популярный выбор для Underlay.

### Как это работает поэтапно:

#### Фаза 1: Установление соседства (Hello-пакеты)
1. **Настройка OSPF Process:** На всех коммутаторах/маршрутизаторах включается OSPF:
   ```
   router ospf 1
   router-id 1.1.1.1
   ```
2. **Обнаружение соседей:** Интерфейсы, участвующие в OSPF, начинают рассылать multicast Hello-пакеты (адрес 224.0.0.5).
3. **Forming Adjacency:** Когда два устройства видят друг друга в Hello-пакетах и параметры совпадают (Area ID, Authentication, MTU), они устанавливают соседство.

#### Фаза 2: Обмен LSAs (Link State Advertisements)
4. **Синхронизация баз данных:** Соседи обмениваются DBD (Database Description) пакетами, чтобы сравнить свои LSDB (Link State Databases).
5. **Запрос недостающей информации:** Если у соседа есть более свежие LSA, устройство запрашивает их с помощью LSR (Link State Request).
6. **Обновление LSDB:** Полученные LSA добавляются в локальную базу данных состояний каналов.

**Типы LSA для Underlay:**
- **LSA Type 1 (Router LSA):** Описывает интерфейсы маршрутизатора и их стоимость (cost)
- **LSA Type 2 (Network LSA):** Генерируется DR (Designated Router) в broadcast-сегментах

#### Фаза 3: Расчет маршрутов (SPF Algorithm)
7. **Построение графа:** Каждый маршрутизатор строит граф сети на основе LSDB.
8. **Алгоритм Дейкстры:** Рассчитывает кратчайшие пути до всех сетей назначения.
9. **Заполнение таблицы маршрутизации:** Найденные маршруты добавляются в RIB (Routing Information Base).

### Конфигурация для Underlay:
```bash
interface Ethernet1/1
  no switchport
  ip address 10.1.1.1/30
  ip ospf network point-to-point  # Критично для p2p линков!
  ip router ospf 1 area 0

router ospf 1
  router-id 1.1.1.1
  passive-interface default
  no passive-interface Ethernet1/1
```

**Преимущества OSPF для Underlay:**
- Быстрая сходимость (sub-second)
- Поддержка ECMP (Equal-Cost Multi-Path)
- Широкая поддержка оборудованием

---

## 2. Построение Underlay сети с IS-IS

**IS-IS (Intermediate System to Intermediate System)** — альтернативный протокол состояния каналов, часто используемый в крупных дата-центрах и сетях провайдеров.

### Ключевые отличия от OSPF:

#### Архитектура уровней:
- **Level 1 (L1):** Маршрутизация внутри area (аналогично OSPF non-backbone areas)
- **Level 2 (L2):** Маршрутизация между areas (аналогично OSPF backbone area)

#### Процесс работы:

#### Фаза 1: Установление соседства
1. **Hello-пакеты (IIH):** Рассылаются отдельно для L1 и L2
2. **Three-way Handshake:** Более надежное установление соседства чем в OSPF

#### Фаза 2: Распространение LSP (Link State PDU)
3. **LSP (Link State PDU):** Аналог LSA в OSPF, но с более гибким форматом TLV
4. **Sequence Number:** Каждый LSP имеет номер для определения актуальности
5. **Flooding:** Распространение LSP по всей area/level

#### Фаза 3: Расчет маршрутов
6. **SPF Algorithm:** Так же как в OSPF - алгоритм Дейкстры
7. **Построение графа:** На основе полученных LSP

### Конфигурация для Underlay:
```bash
router isis UNDERLAY
  net 49.0001.0100.0100.1001.00  # NET Address
  is-type level-2-only           # Для простого Underlay используем только L2
  metric-style wide              # Для поддержки больших метрик

interface Ethernet1/1
  no switchport
  ip address 10.1.1.1/30
  ip router isis UNDERLAY
  isis metric 10
  isis network point-to-point
```

**Преимущества IS-IS для Underlay:**
- Более простая расширяемость (нет понятия Area 0)
- Устойчивость к фрагментации LSP
- Лучшая масштабируемость в очень крупных сетях
- Независимость от IP (работает на уровне 2)

---

## 3. Построение Underlay сети с iBGP

**iBGP (Internal BGP)** — использование BGP внутри автономной системы (AS).

### Особенности построения Underlay:

#### Проблема: "iBGP Full Mesh"
- По умолчанию iBGP требует полносвязной топологии
- Решение: **Route Reflectors (RR)**

#### Архитектура с Route Reflectors:
```
Leaf1 --- Spine1 (RR)
    \     /
     \   /
      Spine2 (RR)
```

#### Процесс работы:

1. **Настройка BGP сессий:**
   - Leafs устанавливают сессии со Spine (Route Reflectors)
   - Spines устанавливают сессии между собой

2. **Анонсирование маршрутов:**
   - Leaf анонсирует свои loopback-адреса в BGP
   - Route Reflector отражает эти маршруты всем другим клиентам

3. **Атрибуты BGP для Underlay:**
   - **NEXT_HOP:** Сохраняется неизменным (в отличие от eBGP)
   - **AS_PATH:** Не изменяется внутри AS
   - **LOCAL_PREF:** Для влияния на исходящий трафик
   - **MED:** Для влияния на входящий трафик

### Конфигурация:
**На Spine (Route Reflector):**
```bash
router bgp 65001
  neighbor LEAF_UNDERLAY_GROUP remote-as 65001
  neighbor LEAF_UNDERLAY_GROUP update-source loopback0
  neighbor LEAF_UNDERLAY_GROUP route-reflector-client
  address-family ipv4 unicast
    network 10.0.0.0/8
```

**На Leaf:**
```bash
router bgp 65001
  neighbor SPINE1 remote-as 65001
  neighbor SPINE1 update-source loopback0
  address-family ipv4 unicast
    network 10.1.1.1/32  # Loopback для VTEP
```

**Преимущества iBGP для Underlay:**
- Единый протокол для Underlay и Overlay (EVPN)
- Отличная масштабируемость с Route Reflectors
- Гибкость политик на основе атрибутов BGP

---

## 4. Построение Underlay сети с eBGP

**eBGP (External BGP)** — использование BGP между разными автономными системами.

### Особенности для Underlay:

#### Архитектура "Pod-AS" или "Spine-Leaf AS":
```
Leaf1 (AS 65001) -- Spine1 (AS 65000)
Leaf2 (AS 65002) -- Spine2 (AS 65000)
```

### Процесс работы:

1. **Настройка eBGP сессий:**
   - Каждый Leaf имеет уникальный AS номер
   - Spines имеют свой AS номер

2. **Модификация атрибутов:**
   - **AS_PATH:** Добавляется AS отправителя
   - **NEXT_HOP:** Меняется на IP адрес eBGP-соседа

3. **Решение проблемы AS_PATH Loop:**
   - BGP автоматически отбрасывает маршруты с собственным AS в пути

### Критичные настройки для Underlay:

```bash
# На Spine (AS 65000)
router bgp 65000
  neighbor 10.1.1.1 remote-as 65001  # Leaf1
  neighbor 10.1.1.2 remote-as 65002  # Leaf2
  address-family ipv4 unicast
    network 10.0.0.0/8
    # AllowAS-in для принятия маршрутов с собственным AS
    neighbor 10.1.1.1 allowas-in 1
    neighbor 10.1.1.2 allowas-in 1

# На Leaf1 (AS 65001)
router bgp 65001
  neighbor 192.168.1.1 remote-as 65000  # Spine1
  neighbor 192.168.2.1 remote-as 65000  # Spine2
  address-family ipv4 unicast
    network 10.1.1.1/32  # Loopback
    # Remove-private-AS для очистки AS_PATH
    neighbor 192.168.1.1 remove-private-as
```

### Реализация ECMP в eBGP Underlay:

```bash
# На Leaf для балансировки нагрузки
router bgp 65001
  maximum-paths 4  # Разрешить до 4 путей с одинаковым весом
```

**Преимущества eBGP для Underlay:**
- **Простота:** Нет необходимости в Route Reflectors
- **Естественный ECMP:** Разные AS номера автоматически решают проблемы loop prevention
- **Гибкость:** Легко добавлять новые Pod'ы с уникальными AS
- **Отказоустойчивость:** Быстрое переключение при сбоях

---

## Сравнительная таблица протоколов для Underlay

| Параметр | OSPF | IS-IS | iBGP | eBGP |
|----------|------|-------|------|------|
| **Сложность** | Средняя | Средняя | Высокая | Низкая |
| **Масштабируемость** | Хорошая | Отличная | Отличная | Отличная |
| **ECMP поддержка** | Отличная | Отличная | Хорошая | Отличная |
| **Конфигурация** | Стандартная | Специфичная | Комplex | Простая |
| **Использование** | Традиционные DC | Крупные DC/SP | EVPN сети | Современные Fabric |

## Заключение

Выбор протокола для Underlay зависит от:
1. **Масштаба сети:** IS-IS для очень крупных, eBGP для средних/крупных
2. **Опыта команды:** OSPF наиболее знаком, eBGP проще в настройке
3. **Архитектуры Overlay:** eBGP идеален для VXLAN EVPN
4. **Производителя оборудования:** Разные вендоры имеют различные best practices

**Современный тренд:** **eBGP** становится де-факто стандартом для построения Underlay в новых дата-центрах благодаря своей простоте, масштабируемости и идеальной интеграции с EVPN overlay.

