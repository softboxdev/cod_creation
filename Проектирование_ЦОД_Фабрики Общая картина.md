
### Общая картина (Что мы строим)

Мы строим Underlay-сеть для фабрики (например, для NSX) по архитектуре **Spine-Leaf**.
*   **Spine** (AS 65000) - магистральный коммутатор.
*   **Leaf1** (AS 65001) и **Leaf2** (AS 65002) - коммутаторы доступа.
*   Между ними работает **eBGP** для обмена маршрутами до Loopback-адресов и, возможно, других сетей.

---

### Что происходит на Spine (AS 65000)?

```bash
router bgp 65000
  neighbor 10.1.1.1 remote-as 65001  # Leaf1
  neighbor 10.1.1.2 remote-as 65002  # Leaf2
  address-family ipv4 unicast
    network 10.0.0.0/8
    # AllowAS-in для принятия маршрутов с собственным AS
    neighbor 192.168.1.1 remove-private-as
```

1.  **`network 10.0.0.0/8`**: Spine анонсирует в BGP большую сеть `10.0.0.0/8`. Это может быть "суммарный" маршрут для всей Underlay-сети или просто пример. Leaf-коммутаторы узнают от Spine, как достичь любых сетей в диапазоне `10.0.0.0/8`.

2.  **`allowas-in 1`** - **Ключевая и потенциально опасная команда.**
    *   **Проблема, которую она решает:** По умолчанию BGP имеет механизм защиты от петель - **AS_PATH**. Если маршрутизатор видит в AS_PATH входящего маршрута свой собственный AS номер, он отбрасывает этот маршрут, считая его петлей.
    *   **Сценарий, где это возникает:**
        *   Допустим, Spine (`AS65000`) анонсирует маршрут `10.0.0.0/8` Leaf1 (`AS65001`).
        *   Leaf1 получает этот маршрут с AS_PATH `[65000]`.
        *   Если на Leaf1 настроен маршрут по умолчанию или есть другие протоколы, он может попытаться *переанонсировать* этот маршрут обратно Spine (например, через `network 10.0.0.0/8` или перераспределение).
        *   Spine получит маршрут `10.0.0.0/8` от Leaf1 с AS_PATH `[65001, 65000]`. Он увидит там свой собственный AS (`65000`) и **отбросит маршрут**.

    *   **Решение:** Команда `allowas-in 1` говорит Spine: "Принимай от соседа маршруты, даже если в их AS_PATH мой AS номер встретился **до 1 раза**".

    **Зачем это нужно?** Часто это костыль для специфичных сценариев, например, когда на Leaf тоже анонсируется агрегированный маршрут, который может "пересекаться" с маршрутом от Spine. **В чистой Underlay-сети этого быть не должно.** Это признак возможной ошибки в дизайне.

---

### Что происходит на Leaf1 (AS 65001)?

```bash
router bgp 65001
  neighbor 192.168.1.1 remote-as 65000  # Spine1
  neighbor 192.168.2.1 remote-as 65000  # Spine2
  address-family ipv4 unicast
    network 10.1.1.1/32  # Loopback
    # Remove-private-AS для очистки AS_PATH
    neighbor 192.168.1.1 remove-private-as
```

1.  **`network 10.1.1.1/32`**: Leaf1 анонсирует в BGP свой Loopback-адрес. Это критически важно для Overlay-сетей (например, NSX), так как именно этот IP (интерфейс Loopback) обычно используется как VTEP - конечная точка для туннелей VXLAN. Spine получит этот маршрут и передаст его всем остальным Leaf-коммутаторам, обеспечивая полную связность "каждый с каждым".

2.  **`remove-private-as`** - **Еще одна "костыльная" команда.**
    *   **Проблема, которую она решает:** Номера AS в диапазоне `64512 - 65534` зарезервированы для **частного использования** (как и IP-адреса `10.0.0.0/8`). Их нельзя анонсировать в публичный интернет.
    *   **Сценарий:** Если ваш Leaf каким-то образом соединен не только со Spine, но и с внешним BGP-соседом (например, провайдером), и вы анонсируете ему свои маршруты, то наличие частного AS (`65001`) в AS_PATH может привести к тому, что провайдер отбросит ваш маршрут.
    *   **Решение:** Команда `remove-private-as` говорит Leaf1: "Перед тем как отправить маршруты соседу `192.168.1.1` (Spine), **удали из AS_PATH все частные AS номера**".

    **Зачем это нужно в Underlay?** Абсолютно не нужно! Spine (`AS65000`) тоже использует частный AS и прекрасно понимает частные номера. Эта команда здесь бессмысленна и может сработать только если Leaf анонсирует маршруты куда-то вовне, что в чистой Underlay-сети не происходит.

---

### Итог и проблема этого дизайна

**Что здесь пытаются сделать?**
Построить Underlay-сеть, где:
*   Spine и Leaf обмениваются маршрутами через eBGP.
*   Leaf анонсируют свои Loopback-адреса.
*   Обеспечивается связность, даже если возникает "переанонс" маршрутов.

**В чем проблема этой конфигурации?**
Она использует команды-костыли (`allowas-in`, `remove-private-as`) для решения проблем, которых **не должно быть в правильно спроектированной Underlay-сети**.

**Правильный (чистый) дизайн должен выглядеть так:**

1.  **На Spine:** Анонсировать только агрегированные маршруты или вообще не анонсировать `10.0.0.0/8`, если в этом нет необходимости. Underlay-сеть должна знать только маршруты до конкретных Loopback-адресов Leaf.
2.  **На Leaf:** Анонсировать только свои конкретные Loopback-адреса (как `10.1.1.1/32`), и больше ничего. Тогда никакого переанонса и петель не возникнет, и `allowas-in` не понадобится.
3.  **Команда `remove-private-as`** должна использоваться **только на границе** между вашей частной AS и провайдерской (публичной) AS.

Эти команды в данном контексте — признак того, что сетевой инженер столкнулся с проблемой (маршруты не проходят) и быстро "залатал" ее, не разобравшись в коренной причине, которая, скорее всего, в избыточных или неправильных анонсах.



---

## Part 1: BGP (Border Gateway Protocol) - "Протокол Интернета"

BGP — это не просто протокол, это **язык**, на котором общаются автономные системы (AS) в интернете.

### Философия BGP

**BGP — это "векторный" протокол маршрутизации.**
*   **В отличие от OSPF/EIGRP**, которые ищут кратчайший путь на основе метрик (стоимости, задержки).
*   **BGP выбирает "лучший" путь на основе политик и атрибутов.**

Представьте, что вы выбираете авиамаршрут:
*   **OSPF:** "Выбери самый короткий путь по километражу"
*   **BGP:** "Выбери маршрут preferred airline, избегая транзита через определенные страны, с минимальным количеством пересадок"

### Ключевые концепции BGP

#### 1. **Путь (AS_PATH) - самый важный атрибут**
```
AS_PATH: [65002, 65001, 64500]
```
Этот путь читается справа налево: "Чтобы достичь сеть, идите через AS64500 → AS65001 → AS65002".

#### 2. **Типы BGP-сессий**
*   **eBGP (External BGP):** Между разными AS (например, между вашей компанией и провайдером). По умолчанию TTL=1.
*   **iBGP (Internal BGP):** Внутри одной AS. Все routers в AS должны иметь согласованную информацию.

#### 3. **Основные атрибуты для выбора пути**
BGP использует строгий порядок при выборе лучшего пути:

1.  **LOCAL_PREF** (самый важный) - "предпочтение внутри AS"
2.  **AS_PATH** - чем короче путь, тем лучше
3.  **ORIGIN** - источник маршрута (IGP, EGP, incomplete)
4.  **MED** - "подсказка" для соседней AS
5.  **eBGP > iBGP** - внешние пути предпочтительнее внутренних

### BGP в Underlay-сети (Spine-Leaf)

```bash
# На Spine (AS 65000)
router bgp 65000
  bgp router-id 192.168.255.1
  neighbor UNDERLAY peer-group
  neighbor UNDERLAY remote-as 65000  # iBGP между Spine
  neighbor LEAF peer-group
  neighbor LEAF remote-as 65001      # eBGP к Leaf
  neighbor LEAF capability extended-nexthop  # Для IPv6 underlay
  
  neighbor 10.1.1.1 peer-group LEAF  # Leaf01
  neighbor 10.1.1.2 peer-group LEAF  # Leaf02
  
  address-family ipv4 unicast
    neighbor UNDERLAY activate
    neighbor LEAF activate
    network 192.168.255.1/32  # Loopback Spine

# На Leaf (AS 65001)  
router bgp 65001
  bgp router-id 10.1.1.1
  neighbor SPINE peer-group
  neighbor SPINE remote-as 65000
  neighbor SPINE ebgp-multihop 2    # Для связи через Loopback
  
  neighbor 192.168.255.1 peer-group SPINE  # Spine01
  neighbor 192.168.255.2 peer-group SPINE  # Spine02
  
  address-family ipv4 unicast
    neighbor SPINE activate
    network 10.1.1.1/32  # Loopback Leaf
```

**Зачем BGP в Underlay?**
- **Масштабируемость:** Легко добавлять новые Spine/Leaf
- **Гибкость:** Богатые политики маршрутизации
- **Стабильность:** Быстрая сходимость при сбоях
- **Единый протокол:** Можно использовать и для Underlay, и для Overlay (EVPN)

---

## Part 2: VXLAN (Virtual Extensible LAN) - "Логические сети поверх физических"

### Проблема, которую решает VXLAN

**Ограничения классических VLAN:**
- Максимум 4094 VLAN (12-битный VID)
- Жесткая привязка к физической сети
- Сложность перемещения VM между дата-центрами

### Как работает VXLAN

VXLAN создает **overlay-сеть** поверх **underlay-сети**:

```
[ VM-A ] --> [ Hypervisor ] --[VXLAN Tunnel]--> [ Hypervisor ] --> [ VM-B ]
    |             |                  |                 |             |
    VLAN 10    VTEP (VXLAN        IP/UDP           VTEP (VXLAN    VLAN 10
                Tunnel End        Underlay          Tunnel End
                Point)            Network           Point)
```

#### Ключевые компоненты VXLAN

1.  **VTEP (VXLAN Tunnel Endpoint)**
    - "Конечная точка туннеля"
    - Обычно это гипервизор (vSphere, Hyper-V) или коммутатор (Leaf)
    - Инкапсулирует/декапсулирует Ethernet-кадры в VXLAN

2.  **VNI (VXLAN Network Identifier)**
    - 24-битный идентификатор (до 16 миллионов логических сетей!)
    - Аналог VLAN ID, но в Overlay

3.  **Инкапсуляция пакета**
```
[ Original Ethernet Frame (VM-A to VM-B) ]  # Payload
[ VXLAN Header (VNI = 10001) ]              # Overlay header  
[ UDP Header (src port: 4789) ]             # Transport
[ IP Header (VTEP-A to VTEP-B) ]            # Underlay
[ Ethernet Header (Leaf to Spine) ]         # Physical
```

### Типы VXLAN

#### 1. **VXLAN с Multicast (Flood-and-Learn)**
- Классический подход, требует настройки multicast в underlay
- VTEP отправляют broadcast/multicast трафик через multicast-группу
- MAC-адреса изучаются "на лету" из входящего трафика

#### 2. **VXLAN с EVPN (Control-Plane Learning)**
- Современный подход, использует BGP EVPN для обмена MAC/IP-маршрутами
- **Не требует multicast** в underlay
- Централизованное управление MAC-таблицами через BGP

---

## Part 3: BGP EVPN + VXLAN - "Идеальный симбиоз"

### Почему именно эта комбинация?

**BGP EVPN решает главную проблему VXLAN: "как VTEP узнают о MAC-адресах друг друга?"**

### Архитектура BGP EVPN

```
    [VM-A]       [VM-B]       [VM-C]
      |            |            |
   [Leaf-01]    [Leaf-02]    [Leaf-03]    <- VTEP (VXLAN Endpoints)
      |            |            |
    [ Spine-01 ]-[ Spine-02 ]             <- BGP Route Reflectors
```

### Типы маршрутов BGP EVPN

1.  **Type 2: MAC/IP Advertisement**
    ```bash
    Route-Type: 2 (MAC/IP)
    VNI: 10001
    MAC: AA:BB:CC:DD:EE:FF (VM-A)
    IP: 192.168.1.10
    Next-Hop: 10.1.1.1 (VTEP Leaf-01)
    ```
    - Сообщает "MAC-адрес VM-A находится на Leaf-01"

2.  **Type 3: Inclusive Multicast Ethernet Tag**
    - Заменяет multicast для broadcast трафика
    - Создает список всех VTEP в VNI

3.  **Type 5: IP Prefix Route**
    - Для маршрутизации между подсетями (L3)

### Пример полной конфигурации

```bash
# На Spine (BGP Route Reflector)
router bgp 65000
  bgp router-id 192.168.255.1
  neighbor UNDERLAY peer-group
  neighbor UNDERLAY remote-as 65000
  neighbor EVPN peer-group
  neighbor EVPN remote-as 65000
  neighbor EVPN update-source loopback0
  
  neighbor 10.1.1.1 peer-group EVPN  # Leaf-01 loopback
  neighbor 10.1.1.2 peer-group EVPN  # Leaf-02 loopback
  
  address-family ipv4 unicast
    neighbor UNDERLAY activate
    
  address-family l2vpn evpn
    neighbor EVPN activate
    neighbor EVPN route-reflector-client

# На Leaf (VTEP)
router bgp 65001
  bgp router-id 10.1.1.1
  
  ! EVPN соседство со Spine
  neighbor 192.168.255.1 remote-as 65000
  neighbor 192.168.255.1 update-source loopback0
  
  address-family l2vpn evpn
    neighbor 192.168.255.1 activate
    
  ! Настройка VXLAN
  interface nve1
    source-interface loopback0
    member vni 10001
      mcast-group 239.1.1.1  # Для классического VXLAN
    member vni 10001
      ingress-replication    # Для EVPN - без multicast
```

### Процесс обмена маршрутами

1.  **Обучение локальных MAC:**
    - Leaf-01 изучает MAC VM-A на подключенном порту
    - Создает EVPN Type 2 маршрут

2.  **Анонсирование маршрутов:**
    - Leaf-01 отправляет BGP UPDATE Spine: "MAC VM-A на Leaf-01"

3.  **Распространение маршрутов:**
    - Spine (как Route Reflector) отправляет маршрут всем Leaf

4.  **Построение VXLAN туннеля:**
    - Leaf-02 получает маршрут и добавляет в таблицу: "MAC VM-A → VTEP 10.1.1.1"
    - При отправке трафика к VM-A инкапсулирует кадр в VXLAN с назначением 10.1.1.1

### Преимущества комбинации BGP EVPN + VXLAN

1.  **Масштабируемость:** 16 миллионов VNI против 4094 VLAN
2.  **Гибкость:** VM могут мигрировать между любыми Leaf без изменения IP/MAC
3.  **Эффективность:** Точечная доставка unicast трафика вместо flood-and-learn
4.  **Единый контроль-плейн:** BGP управляет и Underlay (IP), и Overlay (MAC/IP)
5.  **Мультивендорность:** Открытые стандарты (больше vendor lock-in)

### Реальный пример работы

```bash
# Показать EVPN таблицу на Leaf
show bgp l2vpn evpn
   Network          Next Hop        Metric LocPrf Weight Path
*> [2]:[10001]:[00aa.bbcc.ddee]/304
                    10.1.1.1             0 65000      0 i
    - VNI 10001, MAC 00:aa:bb:cc:dd:ee, Next-Hop 10.1.1.1 (Leaf-01)

# Показать MAC-таблицу VXLAN
show mac address-table vxlan
   Vlan    Mac Address     Type    Ports    Remote VTEP
   10001   00aa.bbcc.ddee  DYNAMIC Vxlan    10.1.1.1
```

**Итог:** BGP EVPN + VXLAN — это промышленный стандарт для построения современных SDN-фабрик, обеспечивающий беспрецедентную гибкость, масштабируемость и управляемость в крупных дата-центрах.