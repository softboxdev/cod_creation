**Фабрики (Overlay) и классическая структурированная кабельная система (КСПД)**

Давайте разберем это на простой аналогии, а затем на технических деталях.

### Аналогия: Дороги и Навигатор

*   **Классическая КСПД (патч-панели, медные/оптические линии)** — это **дороги, развязки и знаки**. Это физическая инфраструктура, которая всегда остается на месте. Она обеспечивает базовую связность от точки А до точки Б.
*   **Сетевая фабрика (NSX и подобные)** — это **приложение-навигатор (типа Яндекс.Карт) и правила движения**, которые вы в нем задаете.
    *   **Underlay (физическая сеть Spine-Leaf)** — это **скоростные магистрали с идеальной навигационной разметкой**. Навигатор знает все эти дороги и использует их для быстрого расчета пути.
    *   **Overlay (логические сети NSX)** — это **логические маршруты и правила**, которые навигатор строит поверх дорог. Вы можете создать "зеленый маршрут" для одних машин и "платный маршрут" для других, не меняя асфальт и знаки.

**Итог аналогии:** Навигатор (фабрика) не отменяетneed for дорог (КСПД). Но он делает их "умнее", позволяя гибко управлять потоками поверх неизменной физики.

---

### Технические аспекты сосуществования

#### 1. Роль КСПД меняется с "логической" на "транспортную"

*   **В классической сети:** КСПД напрямую определяла логическую топологию. VLAN, прокинутый с 1-го на 3-й этаж, — это физические патч-корды на патч-панелях. **Изменение сети = перекоммутация.**
*   **В сети с фабрикой:** КСПД обеспечивает только **IP-связность** между портами коммутаторов Spine и Leaf. Ее задача — доставить пакет от одного порта (VTEP на Leaf) до другого (VTEP на другом Leaf). Ей безразлично, какие VLANы или логические сети "ездят" внутри этих пакетов.

**Что это меняет в КСПД:**
*   **Упрощение.** Вместо десятков VLAN для разных сервисов, в underlay обычно работает **один-два транспортных VLAN** для связи Leaf-Spine.
*   **Стабильность.** Физическая коммутация становится статичной. Вы один раз настраиваете L3-связность между Spine и Leaf, и больше к патч-панелям не прикасаетесь.

#### 2. Точки взаимодействия (где они "уживаются")

Фабрика не живет в вакууме. Ей нужно взаимодействовать с унаследованными системами, которые не входят в Overlay. Это ключевые точки интеграции.

**а) Службы общего назначения (Shared Services)**
Это системы, которые должны быть доступны и из Overlay, и из классических сетей:
*   **Active Directory/DNS/DHCP-серверы**
*   **Системы резервного копирования**
*   **Базы данных**
*   **Сервисы печати**

**Решение: Border Leaf и L2 Bridging**
*   **Border Leaf** — это специальный Leaf-коммутатор, который подключен и к Underlay фабрики, и к классической сети.
*   На нем настраивается **Мост (Bridge)** между логическим сегментом NSX и классическим VLAN.
*   **Как работает:** Трафик из Overlay (VXLAN), предназначенный для сервера в классическом VLAN, приходит на Border Leaf. Border Leaf "разворачивает" VXLAN-пакет и отправляет обычный Ethernet-кадр в нужном VLAN на классический коммутатор. И наоборот.

```
[VM в NSX Segment] --(VXLAN)--> [Border Leaf] --(VLAN 10)--> [Классический коммутатор] --(VLAN 10)--> [Физический сервер AD]
```

**б) Доступ к физическим устройствам**
*   **Хранилища данных (SAN/NAS):** Часто остаются в отдельной физической сети (FC или IP-SAN). Гипервизоры имеют отдельные физические сетевые карты (NIC) для трафика хранилищ, которые не затрагиваются NSX.
*   **Сетевые принтеры, СКУД, IP-телефония:** Обычно остаются в классических VLAN. Доступ к ним из Overlay обеспечивается через тот же **Border Leaf**.

**в) Доступ пользователей**
Пользователи в классических VLAN офисной сети должны иметь доступ к приложениям, работающим в Overlay.

**Решение: Маршрутизация на Border Leaf или выделенном шлюзе.**
*   Классическая сеть "знает" (через BGP или статические маршруты), что путь к сетям Overlay лежит через IP-адрес Border Leaf.
*   Border Leaf выполняет маршрутизацию между классическими подсетями и Overlay-сегментами.

---

### Сводная таблица: Разделение обязанностей

| Аспект | Классическая КСПД / L3 Network | SDN-Фабрика (Overlay) |
| :--- | :--- | :--- |
| **Роль** | **Транспорт (Underlay)**. Обеспечивает IP-связность между узлами. | **Логическая сеть (Overlay)**. Создает изолированные L2/L3-домены и сервисы. |
| **Что определяет** | Физические соединения, базовую IP-маршрутизацию (BGP/OSPF). | Виртуальные сети, межсегментную маршрутизацию, фаервол, балансировку. |
| **Гибкость** | Низкая. Изменения требуют физической перекоммутации или настройки коммутаторов. | Высокая. Изменения за секунды через интерфейс менеджера. |
| **Безопасность** | ACL на маршрутизаторах/коммутаторах (на основе IP/портов). | Микросетевание (Microsegmentation). Политики на уровне vNIC ВМ (IP, порты, приложение, пользователь). |
| **Взаимодействие** | Предоставляет транспорт для Overlay и точки интеграции (Border Leaf) для доступа к Shared Services. | Требует от Underlay стабильной IP-связности. Обращается к Shared Services через шлюзы. |

### Итог

**Фабрики и классическая КСПД не враги, а партнеры с разными ролями.**

1.  **Классическая КСПД (вместе с L3-сетью) становится надежным, высокопроизводительным, но "тупым" транспортом (Underlay).** Ее настраивают один раз и забывают.
2.  **SDN-фабрика (Overlay) становится гибким, "умным" слоем логических сетей и сервисов,** который живет поверх этого транспорта.
3.  **Точки интеграции (Border Leaf)** — это "переводчики" между двумя мирами, обеспечивающие беспрепятственный доступ к общим ресурсам и унаследованным системам.

Таким образом, вы не выбрасываете старую КСПД, а **перепрофилируете ее**, переводя из роли активного участника логического построения сети в роль стабильного транспортного фундамента. Вся сложность и гибкость переносится в программный слой.

Для компании с 2000+ сотрудников (предполагая ~500-1000 виртуальных машин и несколько сотен физических серверов) underlay-сеть должна быть **высокопроизводительной, отказоустойчивой и легко масштабируемой**.


### Ключевые принципы построения Underlay для NSX

1.  **Простота и предсказуемость:** Underlay не должна быть "умной". Ее задача — максимально быстро и без потерь передавать IP-пакеты между VTEP.
2.  **Высокая пропускная способность:** Трафик всех overlay-сетей суммируется в underlay. Магистральные каналы должны быть 40/100 Гбит/с.
3.  **Отказоустойчивость (Resiliency):** Полная отказоустойчивость на всех уровнях (Spine-Leaf, Multiple Links, протоколы маршрутизации).
4.  **Сходимость за миллисекунды:** При сбое сеть должна быстро перестраивать маршруты, чтобы не повлиять на overlay.

---

### Рекомендуемая архитектура: Spine-Leaf (Clos)

Это стандарт де-факто для современных ЦОДов. Она идеально подходит для NSX.

*   **Высокая пропускная способность:** Любой Leaf коммутатор соединен с каждым Spine коммутатором.
*   **Предсказуемые задержки:** Любой хост (сервер) находится в 3 хопах от любого другого хоста (Host -> Leaf -> Spine -> Leaf -> Host).
*   **Легкая масштабируемость:** Чтобы добавить мощности, вы добавляете Spine; чтобы добавить серверы — добавляете Leaf.

### Конкретное оборудование (примеры из реального мира)

Для компании на 2000+ человек мы говорим о оборудовании **корпоративного/дата-центрового класса**.

#### Уровень Spine (Магистральные коммутаторы)

**Роль:** Высокоскоростная магистраль для соединения всех Leaf-коммутаторов.
**Требования:**
*   Высокая плотность портов 40/100/400 Гбит/с.
*   Высокая производительность (пропускная способность чипа).
*   Поддержка BGP/EVPN (часто используется в underlay).

**Примеры моделей:**
*   **Cisco:** Nexus 9300-GX/Y series (например, N93**36C-FX2**), Nexus 9500 Series.
*   **Arista:** 7050X3, 7060X5/DX5 Series.
*   **Juniper:** QFX10000 Series.
*   **"Белые" коробки:** На базе чипов Broadcom Tomahawk/Jericho с предустановленной SONiC или Cumulus Linux (часто через партнеров типа Dell, Edgecore).

**Количество:** Обычно начинают с 2-х для отказоустойчивости. Для большей емкости и устойчивости к сбоям — 4 или более.

#### Уровень Leaf (Коммутаторы доступа)

**Роль:** Подключение всех серверов, гипервизоров, физических устройств, а также подключение к внешним сетям (интернет, филиалы).
**Требования:**
*   Высокая плотность портов 10/25 Гбит/с на серверы и аплинки 40/100 Гбит/с на Spine.
*   Низкая задержка.
*   Поддержка BGP/EVPN.

**Примеры моделей:**
*   **Cisco:** Nexus 9300-FX2/GX Series (например, **N9K-C9336C-FX2** — универсальный вариант, который может работать и как Spine, и как Leaf).
*   **Arista:** 7050CX3, 7060CX5 Series.
*   **Juniper:** QFX5120, QFX5200 Series.
*   **"Белые" коробки:** Очень популярны на этом уровне из-за соотношения цены и производительности.

**Количество:** Зависит от количества серверных шкафов. Обычно 2 Leaf'а на стойку для отказоустойчивости.

---

### Сетевая стека (протоколы) для Underlay

Оборудование — это только половина дела. Вторая половина — ПО и протоколы, которые на нем работают.

1.  **Протокол маршрутизации — BGP (рекомендуется) или OSPF:**
    *   **BGP** — это золотой стандарт. Он масштабируется лучше всего. Каждый Leaf и Spine коммутатор работает как BGP-спикер.
    *   **eBGP между Spine и Leaf** — самая простая и популярная конфигурация. Spine-коммутаторы узнают все маршруты от всех Leaf и распределяют их между собой.

2.  **Протокол канального уровня — EVPN (часто используется в связке с BGP):**
    *   Хотя для чистого underlay EVPN не обязателен, он часто включается в дизайн "под ключ", так как обеспечивает единый протокол и для underlay (маршруты до VTEP), и для возможного overlay (если нужно L2 поверх L3).

3.  **Протокол первого прыжка — Anycast Gateway:**
    *   Шлюз по умолчанию для всех серверов в одном VLAN/VXLAN размещается на **всех** Leaf-коммутаторах с одним и тем же IP-адресом (Anycast). Это обеспечивает оптимальный маршрут и отказоустойчивость.

### Схематичный пример

```
                      [ Внешний мир / Интернет ]
                               |
                               | (BGP)
                      [ Border Leaf Switches ]  <-- Опциональный уровень
                               | \
                              /   \  (100Gb Ethernet)
                             /     \
                 [Spine-01]--------[Spine-02]  <-- Уровень Spine (BGP)
                  /    \             /    \
           (100Gb)   (100Gb)  (100Gb)   (100Gb)
               /         \         /         \
      [Leaf-01]         [Leaf-02]         [Leaf-0N]  <-- Уровень Leaf (BGP)
       /   \   \         /   \   \         /   \
   [ESXi-01] [ESXi-02] [ESXi-03] [ESXi-04] ... [Физич. серверы, KVM, etc.]
     (VTEP)   (VTEP)   (VTEP)   (VTEP)          (VTEP)
```

### Итог: Какое оборудование будет в составе Underlay для компании 2000+?

1.  **Архитектура:** Spine-Leaf (Clos).
2.  **Spine-коммутаторы:** 2-4 штуки, высокой производительности, с портами 100/400 Гбит/с (Cisco Nexus 93xx, Arista 7050X3 и аналоги).
3.  **Leaf-коммутаторы:** Десятки штук (в зависимости от стоек), с портами 25 Гбит/с на сервер и 100 Гбит/с на аплинк (Cisco Nexus 93xx-FX2, Arista 7050CX3 и аналоги).
4.  **Сетевая ОС и протоколы:** BGP (eBGP) как протокол маршрутизации underlay. Оборудование должно его поддерживать.
5.  **Скорости:** Серверы подключаются на 25 Гбит/с, магистральные каналы (Leaf-Spine) — на 100 Гбит/с и выше.

Такой underlay будет надежным, производительным фундаментом для развертывания NSX и любых других overlay-технологий на ближайшие 5-7 лет.